# Backend Requirements: TOTP 2FA (Authenticator App)

This document specifies the exact API contracts and behaviors required by the frontend to support TOTP-based 2FA. Keep the structures identical to avoid breaking `src/services/auth/authService.ts` and `src/services/auth/authModels.ts`.

## Summary
- Primary login remains `POST /auth/login`.
- If the account has 2FA enabled, `/auth/login` returns an MFA challenge with `mfaTempToken` (no JWT).
- The client then calls `POST /auth/mfa/verify` with the 6‑digit code and `mfaTempToken` to receive the final JWT.
- Users can manage 2FA (start setup, confirm code, view recovery codes, disable) from their profile.

---

## Endpoints and Payloads

### 1) POST /auth/login
Request
```json
{ "email": "user@example.com", "password": "••••••••" }
```
Responses
- Success (no 2FA enabled):
```json
{ "success": true, "message": "OK", "data": { "token": "<JWT>", "user": { /* user */ } } }
```
- Success (2FA enabled → challenge):
```json
{ "success": true, "message": "MFA required", "data": { "mfaRequired": true, "mfaTempToken": "<opaque-temporary-token>" } }
```
- Failure:
```json
{ "success": false, "message": "Invalid email or password" }
```
Notes
- Do NOT return a JWT when `mfaRequired` is true.
- `mfaTempToken` must be short-lived (e.g., 5–10 minutes), single-use, tied to the user/session.

### 2) POST /auth/mfa/verify
Completes login when 2FA is required.

Request
```json
{ "code": "123456", "mfaTempToken": "<opaque-temporary-token>" }
```
Responses
- Success (issue real JWT):
```json
{ "success": true, "message": "OK", "data": { "token": "<JWT>", "user": { /* user */ } } }
```
- Failure (invalid/expired):
```json
{ "success": false, "message": "Invalid or expired code" }
```
Notes
- Accept 6-digit TOTP codes (RFC 6238) and optionally a recovery code (backend may support either).
- Invalidate `mfaTempToken` after use; apply rate limiting and lockouts on repeated failures.

### 3) POST /auth/mfa/setup/start
Begins TOTP setup for the authenticated user.

Auth: Bearer JWT

Response
```json
{
  "success": true,
  "message": "OK",
  "data": {
    "secret": "BASE32SECRET",
    "otpauthUrl": "otpauth://totp/App:email?secret=BASE32SECRET&issuer=App&digits=6&period=30&algorithm=SHA1",
    "qrCodeDataUrl": "data:image/png;base64,..." // optional
  }
}
```
Notes
- Generate and store a pending secret associated with the user until confirmation.
- If `qrCodeDataUrl` is omitted, the FE displays `otpauthUrl` and the `secret` as text.

### 4) POST /auth/mfa/setup/confirm
Confirms TOTP setup by verifying a valid 6-digit code generated by the new secret.

Auth: Bearer JWT

Request
```json
{ "code": "123456" }
```
Response
```json
{ "success": true, "message": "2FA enabled", "data": { "recoveryCodes": ["ABCD-EFGH", "IJKL-MNOP"] } }
```
Notes
- On success, persist 2FA as enabled for the user and finalize the secret.
- Generate 8–10 one-time recovery codes; return plaintext only at this time (hash at rest).

### 5) GET /auth/mfa/recovery-codes
Returns the user’s current recovery codes (or regenerates and returns a new set).

Auth: Bearer JWT

Response
```json
{ "success": true, "message": "OK", "data": { "recoveryCodes": ["ABCD-EFGH", "IJKL-MNOP"] } }
```
Notes
- Consider returning plaintext only on regeneration. If not regenerating, either return masked codes or make this endpoint regenerate by design.

### 6) POST /auth/mfa/disable
Disables 2FA for the authenticated user.

Auth: Bearer JWT

Response
```json
{ "success": true, "message": "2FA disabled" }
```
Notes
- Optionally require a password recheck and/or TOTP code for security.

---

## User Model Expectations
The `user` object returned in auth responses should include a flag:
```json
{ "id": 1, "email": "user@example.com", "twoFactorEnabled": true, /* ... */ }
```

---

## Security & Operational Considerations
- **OTP Parameters**: TOTP (RFC 6238), 6 digits, 30s period, SHA1 (or better if both sides agree).
- **Time Sync**: Ensure server time is NTP-synchronized; allow small skew (e.g., ±1 step).
- **Lockouts/Rate Limiting**: Apply rate limiting to `/auth/mfa/verify` and login attempts; consider temporary account lock on repeated failures.
- **Token Handling**: `mfaTempToken` must not grant any privilege beyond completing TOTP verification. Expire it aggressively and invalidate after success.
- **Secret Storage**: Store TOTP secrets encrypted or hashed (if using reversible encryption, protect keys). Never expose secrets after confirmation.
- **Recovery Codes**: Store hashed; mark as consumed on use; provide regeneration (and invalidate old ones).
- **Auditing**: Log enable/disable, verification attempts (without codes), and recovery code regenerations.

---

## Error Conventions
- All endpoints return:
```json
{ "success": boolean, "message": string, "data?": any }
```
- Use clear messages for: invalid credentials, invalid/expired code, rate limit exceeded, setup not started, already enabled, etc.

---

## Example Libraries (Backend)
- Node.js: `otplib`, `speakeasy` for TOTP; `qrcode` for QR data URL.
- .NET: `Otp.Net`.
- Java: `GoogleAuthenticator` libraries.

---

## Frontend Contracts Reference
- Code references:
  - `src/services/auth/authModels.ts`
  - `src/services/auth/authService.ts`
  - `src/store/slices/authSlice.ts`
  - `src/pages/auth/Login.tsx`
  - `src/pages/Profile.tsx`
